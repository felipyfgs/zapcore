openapi: 3.0.3
info:
  title: WAMEX API
  description: |
    Sistema de Envio de Mensagens WhatsApp com Suporte Multi-Source
    
    ## Nova Funcionalidade Multi-Source Media
    
    A rota `POST /message/{sessionID}/send/media` agora suporta **4 fontes diferentes** de mídia:
    
    1. **MinIO ID** - Compatibilidade com sistema existente
    2. **Base64** - Data URL base64 para envio direto
    3. **URL Externa** - Download de URLs públicas
    4. **Upload Direto** - Upload via multipart/form-data
    
    ### Detecção Automática
    - Tipo MIME detectado automaticamente
    - Tipo de mensagem WhatsApp determinado automaticamente
    - Validações de segurança implementadas
    
    ### Resposta Unificada
    - Informações detalhadas sobre processamento
    - Tempo de processamento
    - Fonte utilizada
    - Metadados da mídia
  version: 2.0.0
  contact:
    name: WAMEX Support
    url: https://github.com/felipyfgs/wamex
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Servidor de desenvolvimento
  - url: https://api.wamex.com
    description: Servidor de produção

tags:
  - name: sessions
    description: Gerenciamento de sessões WhatsApp
  - name: messages
    description: Envio de mensagens
  - name: media
    description: Gerenciamento de mídia
  - name: media-multi-source
    description: Nova funcionalidade multi-source para mídia

paths:
  /message/{sessionID}/send/media:
    post:
      tags:
        - media-multi-source
      summary: Enviar mídia com suporte multi-source
      description: |
        **NOVA FUNCIONALIDADE**: Envia mídia via WhatsApp com suporte a múltiplas fontes.
        
        Suporta 4 tipos de fonte (apenas uma deve ser fornecida):
        - **mediaId**: ID do MinIO (compatibilidade)
        - **base64**: Data URL base64
        - **url**: URL externa
        - **file**: Upload direto via multipart
        
        ### Detecção Automática
        - Tipo MIME detectado via magic numbers
        - Tipo de mensagem WhatsApp determinado automaticamente
        - Validações de segurança aplicadas
        
        ### Validações de Segurança
        - Rate limiting por sessão/IP
        - Whitelist de domínios para URLs
        - Validação de magic numbers
        - Limites de tamanho por tipo de mídia
      parameters:
        - name: sessionID
          in: path
          required: true
          description: ID ou nome da sessão WhatsApp
          schema:
            type: string
            example: "teste"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMediaMessageRequest'
            examples:
              minioId:
                summary: Envio via MinIO ID
                value:
                  phone: "5511999999999"
                  mediaId: "4a5347eb-33c5-4048-babc-0661cbba1b9b"
                  caption: "Mídia do MinIO"
              base64:
                summary: Envio via Base64
                value:
                  phone: "5511999999999"
                  base64: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..."
                  caption: "Imagem em base64"
                  filename: "imagem.jpg"
              url:
                summary: Envio via URL Externa
                value:
                  phone: "5511999999999"
                  url: "https://example.com/image.jpg"
                  caption: "Imagem de URL pública"
                  filename: "externa.jpg"
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/SendMediaMessageMultipart'
            example:
              phone: "5511999999999"
              caption: "Arquivo enviado diretamente"
              file: "[arquivo binário]"
      responses:
        '200':
          description: Mídia enviada com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMediaMessageResponse'
              example:
                success: true
                message: "Media message sent successfully"
                timestamp: "2025-07-13T19:48:08Z"
                details:
                  phone: "5511999999999"
                  type: "image"
                  status: "sent"
                  sentAt: "2025-07-13T19:48:08Z"
                  sessionName: "teste"
                  source: "base64"
                  mediaInfo:
                    filename: "image.jpg"
                    mimeType: "image/jpeg"
                    originalSize: 1024000
                    detectedType: "image"
                    processingTime: "245ms"
                  whatsappInfo:
                    messageId: "3EB0CA5F091171BDE7E085"
                    directPath: "/v/t62.7114-24/..."
                    url: "https://mmg.whatsapp.net/..."
        '400':
          description: Erro de validação
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noSource:
                  summary: Nenhuma fonte fornecida
                  value:
                    success: false
                    error: "MEDIA_PROCESSING_ERROR"
                    message: "nenhuma fonte de mídia fornecida (mediaId, base64, url ou file)"
                multipleSources:
                  summary: Múltiplas fontes fornecidas
                  value:
                    success: false
                    error: "MEDIA_PROCESSING_ERROR"
                    message: "apenas uma fonte de mídia deve ser fornecida por vez"
                invalidUrl:
                  summary: URL inválida
                  value:
                    success: false
                    error: "MEDIA_PROCESSING_ERROR"
                    message: "URL inválida: domínio não está na whitelist"
        '404':
          description: Sessão não encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    SendMediaMessageRequest:
      type: object
      description: Requisição para envio de mídia multi-source
      required:
        - phone
      properties:
        phone:
          type: string
          description: Número de telefone do destinatário
          example: "5511999999999"
        mediaId:
          type: string
          description: ID da mídia no MinIO (compatibilidade)
          example: "4a5347eb-33c5-4048-babc-0661cbba1b9b"
        base64:
          type: string
          description: Data URL base64 da mídia
          example: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..."
        url:
          type: string
          description: URL pública da mídia
          example: "https://example.com/image.jpg"
        caption:
          type: string
          description: Legenda opcional da mídia
          example: "Minha imagem"
        messageType:
          type: string
          description: Tipo de mensagem (auto-detectado se não fornecido)
          enum: [image, audio, video, document, sticker]
          example: "image"
        filename:
          type: string
          description: Nome customizado do arquivo
          example: "minha-imagem.jpg"
      oneOf:
        - required: [mediaId]
        - required: [base64]
        - required: [url]
        - required: [file]

    SendMediaMessageMultipart:
      type: object
      description: Requisição multipart para upload direto
      required:
        - phone
        - file
      properties:
        phone:
          type: string
          description: Número de telefone do destinatário
        caption:
          type: string
          description: Legenda opcional da mídia
        messageType:
          type: string
          description: Tipo de mensagem (auto-detectado se não fornecido)
        filename:
          type: string
          description: Nome customizado do arquivo
        file:
          type: string
          format: binary
          description: Arquivo de mídia

    SendMediaMessageResponse:
      type: object
      description: Resposta unificada do envio de mídia
      properties:
        success:
          type: boolean
          description: Indica se o envio foi bem-sucedido
        message:
          type: string
          description: Mensagem de status
        timestamp:
          type: string
          format: date-time
          description: Timestamp da resposta
        details:
          type: object
          properties:
            phone:
              type: string
              description: Número do destinatário
            type:
              type: string
              description: Tipo de mídia detectado
            status:
              type: string
              description: Status do envio
            sentAt:
              type: string
              format: date-time
              description: Timestamp do envio
            sessionName:
              type: string
              description: Nome da sessão
            source:
              type: string
              description: Fonte utilizada
              enum: [mediaId, base64, url, upload]
            mediaInfo:
              type: object
              properties:
                filename:
                  type: string
                  description: Nome do arquivo
                mimeType:
                  type: string
                  description: Tipo MIME detectado
                originalSize:
                  type: integer
                  description: Tamanho original em bytes
                detectedType:
                  type: string
                  description: Tipo de mensagem detectado
                processingTime:
                  type: string
                  description: Tempo de processamento
            whatsappInfo:
              type: object
              properties:
                messageId:
                  type: string
                  description: ID da mensagem no WhatsApp
                directPath:
                  type: string
                  description: Caminho direto no WhatsApp
                url:
                  type: string
                  description: URL da mídia no WhatsApp

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Código do erro
        message:
          type: string
          description: Mensagem de erro
        timestamp:
          type: string
          format: date-time
          description: Timestamp do erro
